# docker-selkies-egl-desktop

KDE Plasma Desktop container designed for Kubernetes, supporting OpenGL EGL and GLX, Vulkan, and Wine/Proton for NVIDIA GPUs through WebRTC and HTML5, providing an open-source remote cloud/HPC graphics or game streaming platform.

[![Build](https://github.com/selkies-project/docker-selkies-egl-desktop/actions/workflows/container-publish.yml/badge.svg)](https://github.com/selkies-project/docker-selkies-egl-desktop/actions/workflows/container-publish.yml)

[![Discord](https://img.shields.io/badge/dynamic/json?logo=discord&label=Discord%20Members&query=approximate_member_count&url=https%3A%2F%2Fdiscordapp.com%2Fapi%2Finvites%2FwDNGDeSW5F%3Fwith_counts%3Dtrue)](https://discord.gg/wDNGDeSW5F)

**Support:** [Discord](https://discord.gg/wDNGDeSW5F) | [GitHub Discussions](https://github.com/selkies-project/docker-selkies-egl-desktop/discussions) | [Issues](https://github.com/selkies-project/docker-selkies-egl-desktop/issues)

---

## Quick Start

```bash
# 1. Build your user image (password will be prompted)
./build-user-image.sh

# 2. Generate SSL certificate (optional, for HTTPS)
./generate-ssl-cert.sh

# 3. Start the container
./start-container.sh all          # With all GPUs
./start-container.sh none         # Without GPU
./start-container.sh 0            # With GPU 0
./start-container.sh all vnc      # KasmVNC mode

# 4. Access via browser
# â†’ http://localhost:8080 (or https://localhost:8080 if HTTPS enabled)
```

That's it! ðŸŽ‰

---

## Table of Contents

- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Usage](#usage)
- [Scripts Reference](#scripts-reference)
- [Configuration](#configuration)
- [HTTPS/SSL](#httpsssl)
- [Troubleshooting](#troubleshooting)
- [Advanced Topics](#advanced-topics)

---

## Prerequisites

### 1. Linux Host with Docker

Install Docker on your Linux system:

```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER
# Log out and back in for group changes to take effect
```

### 2. NVIDIA GPU (Optional)

If you have an NVIDIA GPU and want hardware acceleration:

```bash
# Install NVIDIA Container Toolkit
distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list

sudo apt-get update && sudo apt-get install -y nvidia-container-toolkit
sudo systemctl restart docker
```

**Without NVIDIA GPU:** You can still use the container with software rendering, AMD, or Intel GPUs.

---

## Installation

### Step 1: Clone Repository

```bash
git clone https://github.com/selkies-project/docker-selkies-egl-desktop.git
cd docker-selkies-egl-desktop
```

### Step 2: Build User Image

The build process is simple - just run:

```bash
./build-user-image.sh
```

This will:
- Pull the pre-built base image (if not already available)
- Prompt you to set a password (input is hidden for security)
- Create a user-specific image matching your host UID/GID
- Take about 1-2 minutes

**Password Setup:**
- You'll be asked to enter a password twice for confirmation
- The password is securely stored in the image during build
- No need to specify password when starting containers

**Environment Variables:**

```bash
# Use a specific base image version
BASE_IMAGE_TAG=v1.0 ./build-user-image.sh

# Set password via environment (for automation)
USER_PASSWORD=mysecurepassword ./build-user-image.sh

# Build without cache
NO_CACHE=true ./build-user-image.sh
```

---

## Usage

### Starting the Container

**Basic usage:**

```bash
./start-container.sh
```

Then open your browser to: **http://localhost:8080**

### Common Options

```bash
# Use HTTPS
ENABLE_HTTPS=true ./start-container.sh

# Use a different port
HTTPS_PORT=9090 ./start-container.sh

# High resolution (4K)
DISPLAY_WIDTH=3840 DISPLAY_HEIGHT=2160 ./start-container.sh

# Without NVIDIA GPU
ENABLE_GPU=false ./start-container.sh

# Foreground mode (see logs directly)
DETACHED=false ./start-container.sh

# Custom container name
CONTAINER_NAME=my-desktop ./start-container.sh
```

### Stopping the Container

```bash
./stop-container.sh
```

### Available Scripts

| Script | Description |
|--------|-------------|
| `build-user-image.sh` | Build your user-specific image |
| `start-container.sh` | Start the desktop container |
| `stop-container.sh` | Stop the container (automatically removed with --rm) |
| `restart-container.sh` | Restart the container |
| `logs-container.sh` | View container logs |
| `shell-container.sh` | Access container shell |
| `delete-image.sh` | Delete the user-specific image |
| `commit-container.sh` | Save container changes to new image |

For detailed script documentation, see [SCRIPTS.md](SCRIPTS.md).

---

## Configuration

### Display Settings

```bash
# Resolution
DISPLAY_WIDTH=1920        # Width in pixels
DISPLAY_HEIGHT=1080       # Height in pixels
DISPLAY_REFRESH=60        # Refresh rate in Hz
DISPLAY_DPI=96            # DPI setting

./start-container.sh
```

### Video Encoding

```bash
# NVIDIA GPU (hardware encoding)
VIDEO_ENCODER=nvh264enc   # H.264 with NVIDIA
VIDEO_BITRATE=8000        # kbps
FRAMERATE=60              # FPS

# Software encoding (no GPU)
VIDEO_ENCODER=x264enc     # H.264 software
VIDEO_BITRATE=4000        # Lower bitrate for CPU

./start-container.sh
```

**Available encoders:**
- `nvh264enc` - NVIDIA H.264 (requires NVIDIA GPU)
- `x264enc` - Software H.264 (CPU)
- `vp8enc` - Software VP8
- `vp9enc` - Software VP9
- `vah264enc` - AMD/Intel hardware encoding

### Audio Settings

```bash
AUDIO_BITRATE=128000      # Audio bitrate in bps (default: 128000)
./start-container.sh
```

### Authentication

```bash
# Container password
PASSWORD=mypassword

# Web interface password (defaults to PASSWORD if not set)
SELKIES_BASIC_AUTH_PASSWORD=mywebpassword

./start-container.sh
```

---

## HTTPS/SSL

### Using Default Self-Signed Certificate

```bash
ENABLE_HTTPS=true ./start-container.sh
```

Access via: **https://localhost:8080** (your browser will show a security warning)

### Using Custom SSL Certificates

```bash
ENABLE_HTTPS=true \
  CERT_PATH=/path/to/cert.pem \
  KEY_PATH=/path/to/key.pem \
  ./start-container.sh
```

### Generating Self-Signed Certificate

```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout key.pem -out cert.pem \
  -subj "/C=US/ST=State/L=City/O=Organization/CN=localhost"
```

For production, use certificates from [Let's Encrypt](https://letsencrypt.org/).

---

## Container Management

### Viewing Logs

```bash
# View last 100 lines
./logs-container.sh

# Follow logs in real-time
FOLLOW=true ./logs-container.sh
```

### Accessing Shell

```bash
# As your user
./shell-container.sh

# As root
AS_ROOT=true ./shell-container.sh
```

### Saving Changes

If you've installed software or made changes in the container:

```bash
# Save to a new image
./commit-container.sh

# Save with a custom tag
COMMIT_TAG=my-setup ./commit-container.sh

# Use the saved image
IMAGE_NAME=devcontainer-ubuntu24.04-egl-desktop-base:my-setup \
  CONTAINER_NAME=my-desktop-2 \
  ./start-container.sh
```

### Deleting Image

Containers are automatically removed when stopped (using `--rm` flag). To delete the user-specific image:

```bash
# Delete your user image
./delete-image.sh

# Force delete (removes associated containers too)
FORCE=true ./delete-image.sh

# Delete a specific user's image
IMAGE_TAG=username ./delete-image.sh
```

---

## Advanced Topics

### Docker Compose

If you prefer docker-compose:

```bash
# Start
USER_IMAGE=devcontainer-ubuntu24.04-egl-desktop-base:$(whoami) \
  docker-compose -f docker-compose.user.yml up -d

# Stop
docker-compose -f docker-compose.user.yml down
```

### Environment Variables Reference

<details>
<summary>Click to expand full environment variables list</summary>

#### Container Settings
- `CONTAINER_NAME` - Container name (default: `devcontainer-egl-desktop-$(whoami)`)
- `IMAGE_NAME` - Image to use (default: `devcontainer-ubuntu24.04-egl-desktop-base:$(whoami)`)
- `DETACHED` - Run in background (default: `true`)

#### Display
- `DISPLAY_WIDTH` - Width in pixels (default: `1920`)
- `DISPLAY_HEIGHT` - Height in pixels (default: `1080`)
- `DISPLAY_REFRESH` - Refresh rate in Hz (default: `60`)
- `DISPLAY_DPI` - DPI setting (default: `96`)

#### Authentication
- Password is set during image build (no runtime configuration needed)
- `SELKIES_BASIC_AUTH_PASSWORD` - Web interface password (can be set at runtime if needed)

#### Video
- `VIDEO_ENCODER` - Video encoder (default: `nvh264enc`)
- `VIDEO_BITRATE` - Video bitrate in kbps (default: `8000`)
- `FRAMERATE` - Frame rate (default: `60`)

#### Audio
- `AUDIO_BITRATE` - Audio bitrate in bps (default: `128000`)

#### HTTPS/SSL
- `ENABLE_HTTPS` - Enable HTTPS (default: `false`)
- `SELKIES_HTTPS_CERT` - Path to SSL certificate
- `SELKIES_HTTPS_KEY` - Path to SSL private key
- `CERT_PATH` - Host path to certificate file (for mounting)
- `KEY_PATH` - Host path to key file (for mounting)

#### GPU
- `ENABLE_GPU` - Enable NVIDIA GPU support (default: `true`)
- `ENABLE_NVIDIA` - Same as `ENABLE_GPU`

#### Network
- `HTTPS_PORT` - Host port to bind (default: `8080`)

</details>

### GPU Support

**NVIDIA GPUs:**
- Requires driver version 450.80.02 or later
- Maxwell generation or newer
- NVENC support for hardware encoding

**AMD/Intel GPUs:**
```bash
ENABLE_GPU=false \
  VIDEO_ENCODER=vah264enc \
  ./start-container.sh
```

**Software Rendering (No GPU):**
```bash
ENABLE_GPU=false \
  VIDEO_ENCODER=x264enc \
  ./start-container.sh
```

### Wine and Gaming

Wine, Winetricks, Lutris, and other gaming tools are pre-installed. You can run Windows applications and games directly.

### Mounting Additional Volumes

Edit `start-container.sh` and add volume mounts:

```bash
CMD="${CMD} -v /path/on/host:/path/in/container"
```

---

## Troubleshooting

### Container Won't Start

```bash
# Check logs
./logs-container.sh

# Check if port is in use
sudo netstat -tulpn | grep 8080

# Use a different port
HTTPS_PORT=8081 ./start-container.sh
```

### GPU Not Detected

```bash
# Check NVIDIA driver
nvidia-smi

# Check Docker can access GPU
docker run --rm --gpus all nvidia/cuda:11.0-base nvidia-smi

# Use software rendering if GPU issues persist
ENABLE_GPU=false ./start-container.sh
```

### Permission Issues

```bash
# Access as root
AS_ROOT=true ./shell-container.sh

# Check user ID matches
id  # on host
./shell-container.sh  # then run 'id' inside container
```

### Cannot Access Web Interface

```bash
# Check container is running
docker ps

# Check nginx is running
./shell-container.sh
# Inside container: supervisorctl status

# Check firewall
sudo ufw status
sudo ufw allow 8080/tcp
```

### Rebuilding Images

```bash
# Rebuild user image without cache
NO_CACHE=true ./build-user-image.sh

# Pull latest base image
docker pull devcontainer-ubuntu24.04-egl-desktop-base:latest
./build-user-image.sh
```

---

## Project Structure

```
docker-selkies-egl-desktop/
â”œâ”€â”€ build-user-image.sh          # Build user-specific image
â”œâ”€â”€ start-container.sh            # Start container
â”œâ”€â”€ stop-container.sh             # Stop container
â”œâ”€â”€ restart-container.sh          # Restart container
â”œâ”€â”€ logs-container.sh             # View logs
â”œâ”€â”€ shell-container.sh            # Access shell
â”œâ”€â”€ delete-image.sh               # Delete user image
â”œâ”€â”€ commit-container.sh           # Save changes
â”œâ”€â”€ docker-compose.yml            # Docker Compose config (base image)
â”œâ”€â”€ docker-compose.user.yml       # Docker Compose config (user image)
â”œâ”€â”€ egl.yml                       # Alternative compose config
â”œâ”€â”€ files/                        # System files
â”‚   â”œâ”€â”€ Dockerfile.base           # Base image definition
â”‚   â”œâ”€â”€ Dockerfile.user           # User image definition
â”‚   â”œâ”€â”€ entrypoint.sh             # Container entrypoint
â”‚   â”œâ”€â”€ kasmvnc-entrypoint.sh     # KasmVNC setup
â”‚   â”œâ”€â”€ selkies-gstreamer-entrypoint.sh  # Selkies setup
â”‚   â”œâ”€â”€ supervisord.conf          # Supervisor config
â”‚   â””â”€â”€ build-base-image.sh       # Base image builder (for maintainers)
â”œâ”€â”€ SCRIPTS.md                    # Detailed script documentation
â”œâ”€â”€ BUILD.md                      # Build documentation
â””â”€â”€ README.md                     # This file
```

---

## Two-Stage Build System

This project uses a two-stage build approach:

1. **Base Image** (pre-built, pull from registry)
   - Contains all system packages and applications
   - Built by project maintainers
   - Shared by all users
   - Size: ~5-10 GB

2. **User Image** (you build this)
   - Built from base image
   - Adds user matching your host UID/GID
   - Personalized for your system
   - Build time: 1-2 minutes

**Why?**
- âœ… Fast setup (no 30-60 minute build)
- âœ… Proper file permissions when mounting host directories
- âœ… Each user gets their own isolated environment
- âœ… Easy updates (just pull new base image)

---

## Contributing

Contributions are welcome! Please read [BUILD.md](BUILD.md) for information on building base images and contributing to the project.

---

## License

Mozilla Public License 2.0

See [LICENSE](LICENSE) file for details.

---

## Related Projects

- [docker-selkies-glx-desktop](https://github.com/selkies-project/docker-selkies-glx-desktop) - Better performance with dedicated X11 server
- [Selkies GStreamer](https://github.com/selkies-project/selkies-gstreamer) - WebRTC streaming component
- [KasmVNC](https://github.com/kasmtech/KasmVNC) - VNC server with web interface

---

## Credits

- Original project: [Selkies Project](https://github.com/selkies-project)
- Maintainers: [@ehfd](https://github.com/ehfd), [@danisla](https://github.com/danisla)
